# 文件系统镜像构建指南

## 概述

文件系统镜像是一个包含多个文件的二进制文件，可以在系统启动时加载到内存中，提供文件查找和读取功能。

## 文件系统格式

### 结构

```
+------------------+
| 文件系统头 (64B) |
+------------------+
| 目录项数组       |
| (每个64字节)     |
+------------------+
| 文件数据区       |
+------------------+
```

### 文件系统头

- `magic`: "RISCVFS" (8字节) - 文件系统标识
- `nfiles`: 文件数量 (4字节)
- `reserved`: 保留字段 (52字节)

### 目录项

每个目录项64字节：
- `name`: 文件名 (56字节，null结尾)
- `offset`: 文件在镜像中的偏移 (4字节)
- `size`: 文件大小 (4字节)

## 使用方法

### 1. 构建文件系统镜像

```bash
# 构建包含init程序的镜像
make fsimg

# 或者手动构建
tools/mkfs fs.img user/init.elf
```

### 2. 添加多个文件

```bash
# 构建包含多个程序的镜像
tools/mkfs fs.img user/init.elf user/program2.elf user/program3.elf
```

### 3. 在内核中加载镜像

目前文件系统镜像需要手动加载到内存中。可以通过以下方式：

1. **编译时嵌入**：将镜像数据编译到内核中
2. **启动时加载**：从磁盘或设备加载镜像到内存

### 示例：编译时嵌入

```c
// 在main.c中
extern const unsigned char fs_image[];
extern const unsigned int fs_image_size;

void main(void) {
    // ... 其他初始化 ...
    
    // 初始化文件系统镜像
    if (fsimg_init((void*)fs_image, fs_image_size) < 0) {
        printf("文件系统镜像加载失败\n");
    }
}
```

## 工具说明

### mkfs 工具

位置：`tools/mkfs.c`

功能：
- 读取多个ELF文件
- 创建文件系统镜像
- 生成目录项和文件数据

编译：
```bash
gcc -o tools/mkfs tools/mkfs.c -Wall -O2
```

使用：
```bash
tools/mkfs <输出镜像> <文件1> [文件2] ...
```

## 文件查找流程

1. 调用 `namei(path)` 查找文件
2. 如果文件系统镜像已加载，从镜像中查找
3. 如果未找到，使用fallback机制（查找预编译的initcode）
4. 返回file结构，包含文件数据

## 扩展功能

### 添加新程序到镜像

1. 编译用户程序为ELF文件
2. 使用mkfs工具添加到镜像：
   ```bash
   tools/mkfs fs.img user/init.elf user/newprogram.elf
   ```
3. 重新编译内核（如果镜像嵌入内核）

### 支持子目录

当前版本支持路径，但所有文件都在根目录。可以扩展：
- 在文件名中包含路径：`bin/ls`, `usr/bin/program`
- 修改 `fsimg_namei()` 支持路径解析

## 限制

- 最大文件数：255
- 文件名最大长度：55字符
- 镜像大小：受可用内存限制
- 当前不支持写入（只读文件系统）

## 未来改进

1. **动态加载**：从磁盘或网络加载镜像
2. **目录支持**：真正的目录结构
3. **文件写入**：支持创建和修改文件
4. **压缩**：镜像压缩以节省空间
5. **索引**：快速文件查找（哈希表等）

